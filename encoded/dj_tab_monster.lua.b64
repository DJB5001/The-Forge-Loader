-- dj_tab_monster.lua
-- Auto Monster Farm with INTEGRATED SMART BLOCKING

return function(Window, Rayfield, Utils)
   local MonsterTab = Window:CreateTab("👾 Monster Farm", nil)
   
   MonsterTab:CreateSection("Configuration")
   
   local Players = game:GetService("Players")
   local LocalPlayer = Players.LocalPlayer
   local RunService = game:GetService("RunService")
   local ReplicatedStorage = game:GetService("ReplicatedStorage")
   
   local farmEnabled = false
   local selectedMonsters = {"Zombie"}
   local farmConnection = nil
   local noclipConnection = nil
   local flyConnection = nil
   local blockConnection = nil
   local currentTargetMonster = nil
   local isMovingToMonster = false
   local flySpeed = 60
   local bodyVelocity = nil
   local bodyGyro = nil
   local autoBlockEnabled = false
   local isBlocking = false
   local lastBlockCheck = 0
   local lastAttackTime = 0
   local blockCooldown = 0.15
   local characterAddedConnection = nil
   local monsterStartTime = 0
   local MONSTER_TIMEOUT = 360
   local MAX_BLOCK_DISTANCE = 100
   local currentMonsterTypeIndex = 1
   local farmBlockConnection = nil
   
   local monsterTypes = {
      "Bomber",
      "Skeleton Rogue",
      "Axe Skeleton",
      "Deathaxe Skeleton",
      "Elite Rogue Skeleton",
      "Elite Deathaxe Skeleton",
      "Zombie",
      "Delver Zombie",
      "Elite Zombie",
      "Brute Zombie",
      "Reaper",
      "Blight Puromancer",
      "Slime",
      "Burning Slime"
   }
   
   print("[MONSTER FARM] Loading...")
   
   local function getPlayerNameFromClaim(claimValue)
      if not claimValue then return nil end
      if claimValue:IsA("Player") then return claimValue.Name end
      if claimValue:IsA("Model") then return claimValue.Name end
      if claimValue.Name then return claimValue.Name end
      return nil
   end
   
   local function isMonsterClaimedByOther(monster)
      if not monster then return false end
      local status = monster:FindFirstChild("Status")
      if not status then return false end
      local damageDone = status:FindFirstChild("DamageDone")
      if not damageDone then return false end
      local claimValue = damageDone.Value
      if not claimValue then return false end
      local claimName = getPlayerNameFromClaim(claimValue)
      if not claimName or claimName == "" then return false end
      return claimName ~= LocalPlayer.Name
   end
   
   local function isMonsterClaimedByUs(monster)
      if not monster then return false end
      local status = monster:FindFirstChild("Status")
      if not status then return false end
      local damageDone = status:FindFirstChild("DamageDone")
      if not damageDone then return false end
      local claimValue = damageDone.Value
      if not claimValue then return false end
      local claimName = getPlayerNameFromClaim(claimValue)
      if not claimName then return false end
      return claimName == LocalPlayer.Name
   end
   
   local function getDistanceToMonster(monster)
      if not monster then return math.huge end
      local char = LocalPlayer.Character
      if not char then return math.huge end
      local hrp = char:FindFirstChild("HumanoidRootPart")
      if not hrp then return math.huge end
      local monsterPart = monster:FindFirstChild("HumanoidRootPart") 
                       or monster.PrimaryPart 
                       or monster:FindFirstChildWhichIsA("BasePart")
      if not monsterPart then return math.huge end
      return (hrp.Position - monsterPart.Position).Magnitude
   end
   
   local function findAllMyMonsters()
      local living = workspace:FindFirstChild("Living")
      if not living then return {} end
      
      local myMonsters = {}
      for _, entity in pairs(living:GetChildren()) do
         local status = entity:FindFirstChild("Status")
         if status then
            local damageDone = status:FindFirstChild("DamageDone")
            if damageDone and damageDone.Value then
               local claimName = getPlayerNameFromClaim(damageDone.Value)
               if claimName == LocalPlayer.Name then
                  local distance = getDistanceToMonster(entity)
                  if distance <= MAX_BLOCK_DISTANCE then
                     table.insert(myMonsters, entity)
                  end
               end
            end
         end
      end
      return myMonsters
   end
   
   local function isMonsterAttacking(monster)
      if not monster then return false end
      local status = monster:FindFirstChild("Status")
      if not status then return false end
      
      local attacking = status:FindFirstChild("Attacking")
      if attacking then
         local attackValue = attacking.Value
         if type(attackValue) == "boolean" and attackValue == true then return true end
         if type(attackValue) == "number" and attackValue > 0 then return true end
         if type(attackValue) == "string" and (attackValue:lower() == "true" or attackValue == "1") then return true end
         if attackValue ~= nil and attackValue ~= false and attackValue ~= 0 then return true end
      end
      
      local humanoid = monster:FindFirstChildOfClass("Humanoid")
      if humanoid then
         local animator = humanoid:FindFirstChildOfClass("Animator")
         if animator then
            for _, track in pairs(animator:GetPlayingAnimationTracks()) do
               local animName = track.Animation.AnimationId:lower()
               if animName:find("attack") or animName:find("punch") or animName:find("swing") then
                  return true
               end
            end
         end
      end
      
      return false
   end
   
   local function startBlock()
      if isBlocking then return end
      
      task.spawn(function()
         pcall(function()
            local startBlockRemote = ReplicatedStorage:WaitForChild("Shared", 1)
               :WaitForChild("Packages", 1):WaitForChild("Knit", 1)
               :WaitForChild("Services", 1):WaitForChild("ToolService", 1)
               :WaitForChild("RF", 1):WaitForChild("StartBlock", 1)
            startBlockRemote:InvokeServer()
            isBlocking = true
         end)
      end)
   end
   
   local function stopBlock()
      if not isBlocking then return end
      
      task.spawn(function()
         pcall(function()
            local stopBlockRemote = ReplicatedStorage:WaitForChild("Shared", 1)
               :WaitForChild("Packages", 1):WaitForChild("Knit", 1)
               :WaitForChild("Services", 1):WaitForChild("ToolService", 1)
               :WaitForChild("RF", 1):WaitForChild("StopBlock", 1)
            stopBlockRemote:InvokeServer()
            isBlocking = false
         end)
      end)
   end
   
   -- FARM INTEGRATED BLOCKING (runs with farm)
   local function enableFarmBlocking()
      if farmBlockConnection then return end
      
      print("[MONSTER FARM] Farm blocking enabled")
      
      farmBlockConnection = RunService.Heartbeat:Connect(function()
         if not farmEnabled then 
            if isBlocking then stopBlock() end
            return 
         end
         
         local currentTime = tick()
         if currentTime - lastBlockCheck < 0.05 then return end
         lastBlockCheck = currentTime
         
         local myMonsters = findAllMyMonsters()
         if #myMonsters == 0 then
            if isBlocking then stopBlock() end
            return
         end
         
         local anyAttacking = false
         for _, monster in ipairs(myMonsters) do
            if isMonsterAttacking(monster) then
               anyAttacking = true
               break
            end
         end
         
         if anyAttacking then
            lastAttackTime = currentTime
            if not isBlocking then startBlock() end
         else
            local timeSinceAttack = currentTime - lastAttackTime
            if isBlocking and timeSinceAttack > blockCooldown then
               stopBlock()
            end
         end
      end)
   end
   
   local function disableFarmBlocking()
      if farmBlockConnection then 
         farmBlockConnection:Disconnect()
         farmBlockConnection = nil
      end
      if isBlocking then stopBlock() end
      print("[MONSTER FARM] Farm blocking disabled")
   end
   
   -- MANUAL AUTO BLOCK (separate toggle for manual fighting)
   local function enableAutoBlock()
      if blockConnection then return end
      
      print("[MONSTER FARM] Manual Auto-Block enabled")
      
      blockConnection = RunService.Heartbeat:Connect(function()
         if not autoBlockEnabled then 
            if isBlocking then stopBlock() end
            return 
         end
         
         local currentTime = tick()
         if currentTime - lastBlockCheck < 0.05 then return end
         lastBlockCheck = currentTime
         
         local myMonsters = findAllMyMonsters()
         if #myMonsters == 0 then
            if isBlocking then stopBlock() end
            return
         end
         
         local anyAttacking = false
         for _, monster in ipairs(myMonsters) do
            if isMonsterAttacking(monster) then
               anyAttacking = true
               break
            end
         end
         
         if anyAttacking then
            lastAttackTime = currentTime
            if not isBlocking then startBlock() end
         else
            local timeSinceAttack = currentTime - lastAttackTime
            if isBlocking and timeSinceAttack > blockCooldown then
               stopBlock()
            end
         end
      end)
   end
   
   local function disableAutoBlock()
      if blockConnection then 
         blockConnection:Disconnect()
         blockConnection = nil
      end
      if isBlocking then stopBlock() end
      print("[MONSTER FARM] Manual Auto-Block disabled")
   end
   
   local function findNextMonster(excludeMonster)
      if #selectedMonsters == 0 then return nil end
      
      local living = workspace:FindFirstChild("Living")
      if not living then return nil end
      
      for i = 1, #selectedMonsters do
         local index = ((currentMonsterTypeIndex - 1 + i - 1) % #selectedMonsters) + 1
         local monsterType = selectedMonsters[index]
         
         for _, entity in pairs(living:GetChildren()) do
            if entity.Name:find("^" .. monsterType) and entity ~= excludeMonster then
               if not isMonsterClaimedByOther(entity) then
                  currentMonsterTypeIndex = index
                  return entity
               end
            end
         end
      end
      
      return nil
   end
   
   local function enableNoclip()
      if noclipConnection then return end
      noclipConnection = RunService.Stepped:Connect(function()
         if not farmEnabled then return end
         local character = LocalPlayer.Character
         if character then
            for _, part in pairs(character:GetDescendants()) do
               if part:IsA("BasePart") then part.CanCollide = false end
            end
         end
      end)
   end
   
   local function disableNoclip()
      if noclipConnection then noclipConnection:Disconnect(); noclipConnection = nil end
      local character = LocalPlayer.Character
      if character then
         for _, part in pairs(character:GetDescendants()) do
            if part:IsA("BasePart") then part.CanCollide = true end
         end
      end
   end
   
   local function setupFlyBodies()
      local character = LocalPlayer.Character
      if not character then return false end
      local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
      if not humanoidRootPart then return false end
      
      for _, obj in pairs(humanoidRootPart:GetChildren()) do
         if obj:IsA("BodyVelocity") or obj:IsA("BodyGyro") then obj:Destroy() end
      end
      
      bodyVelocity = Instance.new("BodyVelocity")
      bodyVelocity.Velocity = Vector3.new(0, 0, 0)
      bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
      bodyVelocity.Parent = humanoidRootPart
      
      bodyGyro = Instance.new("BodyGyro")
      bodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
      bodyGyro.P = 9e4
      bodyGyro.Parent = humanoidRootPart
      return true
   end
   
   local function enableFly()
      if flyConnection then return end
      if not setupFlyBodies() then task.wait(0.5); setupFlyBodies() end
      
      flyConnection = RunService.Heartbeat:Connect(function()
         if not farmEnabled or not bodyVelocity or not bodyGyro then return end
         local char = LocalPlayer.Character
         if not char then return end
         local hrp = char:FindFirstChild("HumanoidRootPart")
         if not hrp then return end
         
         if isMovingToMonster and currentTargetMonster and currentTargetMonster.Parent then
            local targetPart = currentTargetMonster:FindFirstChild("HumanoidRootPart") 
                            or currentTargetMonster.PrimaryPart 
                            or currentTargetMonster:FindFirstChildWhichIsA("BasePart")
            
            if targetPart then
               local targetPos = targetPart.Position - Vector3.new(0, 2, 0)
               local direction = (targetPos - hrp.Position).Unit
               local distance = (targetPos - hrp.Position).Magnitude
               local maxSpeed = math.min(flySpeed, 60)
               local speed = math.min(distance * 2, maxSpeed)
               
               if distance > 5 then
                  bodyVelocity.Velocity = direction * speed
                  bodyGyro.CFrame = CFrame.new(hrp.Position, targetPos)
               else
                  bodyVelocity.Velocity = Vector3.new(0, 0, 0)
                  isMovingToMonster = false
               end
            else
               bodyVelocity.Velocity = Vector3.new(0, 0, 0)
               isMovingToMonster = false
            end
         else
            bodyVelocity.Velocity = Vector3.new(0, 0, 0)
         end
      end)
   end
   
   local function disableFly()
      if flyConnection then flyConnection:Disconnect(); flyConnection = nil end
      if bodyVelocity then bodyVelocity:Destroy(); bodyVelocity = nil end
      if bodyGyro then bodyGyro:Destroy(); bodyGyro = nil end
   end
   
   local function moveToMonster(monster)
      if not monster then return false end
      
      if monster ~= currentTargetMonster then
         monsterStartTime = tick()
         print("[MONSTER FARM] Target:", monster.Name)
      end
      
      currentTargetMonster = monster
      isMovingToMonster = true
      return true
   end
   
   local function activateWeapon()
      if not farmEnabled then return end
      task.spawn(function()
         pcall(function()
            local args = {"Weapon"}
            ReplicatedStorage:WaitForChild("Shared", 1):WaitForChild("Packages", 1)
               :WaitForChild("Knit", 1):WaitForChild("Services", 1)
               :WaitForChild("ToolService", 1):WaitForChild("RF", 1)
               :WaitForChild("ToolActivated", 1):InvokeServer(unpack(args))
         end)
      end)
   end
   
   local function isMonsterValid(monster)
      if not monster then return false end
      if not monster.Parent then return false end
      
      local currentTime = tick()
      local timeFighting = currentTime - monsterStartTime
      
      if timeFighting > MONSTER_TIMEOUT then
         print("[MONSTER FARM] Timeout (6min) - switching monster...")
         return false
      end
      
      if isMonsterClaimedByUs(monster) then return true end
      if isMonsterClaimedByOther(monster) then return false end
      return true
   end
   
   local function startFarming()
      if farmConnection then farmConnection:Disconnect() end
      
      local monsterList = table.concat(selectedMonsters, ", ")
      print("[MONSTER FARM] Farming:", monsterList)
      
      -- Enable integrated smart blocking
      enableFarmBlocking()
      
      enableNoclip()
      task.wait(0.1)
      enableFly()
      
      if Rayfield then
         Rayfield:Notify({
            Title = "Monster Farm", 
            Content = "Farming: " .. (#selectedMonsters > 1 and (#selectedMonsters .. " types") or selectedMonsters[1]), 
            Duration = 3
         })
      end
      
      local spamCount = 0
      local newMonster = findNextMonster(nil)
      if newMonster then moveToMonster(newMonster) end
      
      farmConnection = RunService.Heartbeat:Connect(function()
         if not farmEnabled then return end
         
         local valid = isMonsterValid(currentTargetMonster)
         if not valid then
            local monster = findNextMonster(currentTargetMonster)
            if monster and monster ~= currentTargetMonster then
               moveToMonster(monster)
            end
         end
         
         -- Only attack when NOT blocking
         if not isBlocking then
            activateWeapon()
         end
         
         spamCount = spamCount + 1
         if spamCount >= 200 then spamCount = 0 end
      end)
   end
   
   local function stopFarming()
      if farmConnection then farmConnection:Disconnect(); farmConnection = nil end
      
      -- Disable integrated blocking
      disableFarmBlocking()
      
      disableNoclip()
      disableFly()
      currentTargetMonster = nil
      isMovingToMonster = false
      monsterStartTime = 0
      currentMonsterTypeIndex = 1
      print("[MONSTER FARM] Stopped")
   end
   
   local function setupRespawnHandler()
      if characterAddedConnection then characterAddedConnection:Disconnect() end
      
      characterAddedConnection = LocalPlayer.CharacterAdded:Connect(function(newCharacter)
         if farmEnabled then
            print("[MONSTER FARM] Respawned - restarting...")
            task.wait(1)
            disableFly()
            task.wait(0.5)
            enableNoclip()
            task.wait(0.1)
            enableFly()
            
            currentTargetMonster = nil
            isMovingToMonster = false
            monsterStartTime = 0
            local newMonster = findNextMonster(nil)
            if newMonster then moveToMonster(newMonster) end
         end
      end)
   end
   
   setupRespawnHandler()
   
   MonsterTab:CreateDropdown({
      Name = "Monster Types (Multi-Select)",
      Options = monsterTypes,
      CurrentOption = {"Zombie"},
      MultipleOptions = true,
      Flag = "MonsterFarmTypes",
      Callback = function(Options)
         selectedMonsters = Options
         if #selectedMonsters == 0 then
            selectedMonsters = {"Zombie"}
         end
         currentMonsterTypeIndex = 1
         print("[MONSTER FARM] Selected:", table.concat(selectedMonsters, ", "))
      end,
   })
   
   MonsterTab:CreateSlider({
      Name = "Fly Speed (Max 60)",
      Range = {30, 60},
      Increment = 5,
      Suffix = "Speed",
      CurrentValue = 60,
      Flag = "MonsterFarmFlySpeed",
      Callback = function(Value)
         flySpeed = Value
      end,
   })
   
   MonsterTab:CreateSection("Control")
   
   MonsterTab:CreateToggle({
      Name = "Auto Farm Monsters",
      CurrentValue = false,
      Flag = "AutoMonsterFarm",
      Callback = function(enabled)
         farmEnabled = enabled
         if enabled then
            startFarming()
         else
            stopFarming()
         end
      end,
   })
   
   MonsterTab:CreateParagraph({
      Title = "! WARNING",
      Content = "DO NOT activate Auto Farm and\nAuto Block at the same time!\n\nAuto Farm has smart blocking built-in.\nAuto Block is for manual fighting only."
   })
   
   MonsterTab:CreateToggle({
      Name = "Auto Block (Manual Fighting)",
      CurrentValue = false,
      Flag = "AutoMonsterBlock",
      Callback = function(enabled)
         autoBlockEnabled = enabled
         if enabled then
            enableAutoBlock()
         else
            disableAutoBlock()
         end
      end,
   })
   
   MonsterTab:CreateParagraph({
      Title = "Multi-Monster Farming",
      Content = "Select MULTIPLE monster types!\nAuto-switches when unavailable.\n\nSmart Blocking BUILT-IN:\n- Blocks when monster attacks\n- Attacks when monster pauses\n- Multi-monster support (100m)\n- 0.15s response time"
   })
   
   MonsterTab:CreateParagraph({
      Title = "Features",
      Content = "14 Monster Types + Multi-select\nIntegrated Smart Blocking\nAuto fly + noclip\n6-minute timeout\nAuto-restart after death\n\nSettings auto-saved!"
   })
   
   print("[MONSTER FARM] Ready!")
   
   game:GetService("Players").PlayerRemoving:Connect(function(player)
      if player == LocalPlayer then 
         stopFarming()
         if characterAddedConnection then characterAddedConnection:Disconnect() end
      end
   end)
end